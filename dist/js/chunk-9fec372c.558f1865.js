(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-9fec372c"],{"13d5":function(t,e,n){"use strict";var a=n("23e7"),r=n("d58f").left,s=n("a640"),i=n("ae40"),o=n("2d00"),u=n("605d"),c=s("reduce"),l=i("reduce",{1:0}),d=!u&&o>79&&o<83;a({target:"Array",proto:!0,forced:!c||!l||d},{reduce:function(t){return r(this,t,arguments.length,arguments.length>1?arguments[1]:void 0)}})},"216b":function(t,e,n){},"223c":function(t,e,n){"use strict";n.r(e);var a=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"toastification"},[n("div",{staticClass:"d-flex align-items-start"},[n("b-avatar",{staticClass:"mr-75 flex-shrink-0",attrs:{variant:t.variant,size:"1.8rem"}},[n("feather-icon",{attrs:{icon:t.icon,size:"15"}})],1),n("div",{staticClass:"d-flex flex-grow-1"},[n("div",[t.title?n("h5",{staticClass:"mb-0 font-weight-bolder toastification-title",class:"text-"+t.variant,domProps:{textContent:t._s(t.title)}}):t._e(),t.text?n("small",{staticClass:"d-inline-block text-body",domProps:{textContent:t._s(t.text)}}):t._e()]),n("span",{staticClass:"cursor-pointer toastification-close-icon ml-auto ",on:{click:function(e){return t.$emit("close-toast")}}},[t.hideClose?t._e():n("feather-icon",{staticClass:"text-body",attrs:{icon:"XIcon"}})],1)])],1)])},r=[],s=n("e8a3"),i={components:{BAvatar:s["a"]},props:{variant:{type:String,default:"primary"},icon:{type:String,default:null},title:{type:String,default:null},text:{type:String,default:null},hideClose:{type:Boolean,default:!1}}},o=i,u=(n("2edd"),n("2877")),c=Object(u["a"])(o,a,r,!1,null,"55dd3057",null);e["default"]=c.exports},"2edd":function(t,e,n){"use strict";n("216b")},"4e82":function(t,e,n){"use strict";var a=n("23e7"),r=n("1c0b"),s=n("7b0b"),i=n("d039"),o=n("a640"),u=[],c=u.sort,l=i((function(){u.sort(void 0)})),d=i((function(){u.sort(null)})),m=o("sort"),p=l||!d||!m;a({target:"Array",proto:!0,forced:p},{sort:function(t){return void 0===t?c.call(s(this)):c.call(s(this),r(t))}})},"5da8":function(t,e,n){},7793:function(t,e,n){"use strict";n("5da8")},d58f:function(t,e,n){var a=n("1c0b"),r=n("7b0b"),s=n("44ad"),i=n("50c4"),o=function(t){return function(e,n,o,u){a(n);var c=r(e),l=s(c),d=i(c.length),m=t?d-1:0,p=t?-1:1;if(o<2)while(1){if(m in l){u=l[m],m+=p;break}if(m+=p,t?m<0:d<=m)throw TypeError("Reduce of empty array with no initial value")}for(;t?m>=0:d>m;m+=p)m in l&&(u=n(u,l[m],m,c));return u}};t.exports={left:o(!1),right:o(!0)}},f304:function(t,e,n){"use strict";n.r(e);var a=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"payment-container"},[n("b-overlay",{staticClass:"loading-overlay",attrs:{show:t.loading,rounded:"sm",opacity:"0.85","no-wrap":""},scopedSlots:t._u([{key:"overlay",fn:function(){return[n("div",{staticClass:"text-center"},[n("b-spinner",{staticClass:"mb-3",attrs:{type:"grow",variant:"primary"}}),n("p",{staticClass:"h4"},[t._v("Processing Payment...")]),n("p",[t._v("Creating ticket and printing receipt")])],1)]},proxy:!0}])},[n("div")]),n("div",{staticClass:"panel-summary"},[n("div",{staticClass:"summary-left"},[n("b-button",{staticClass:"back-btn",attrs:{variant:"outline-secondary",disabled:t.loading},on:{click:t.goBack}},[n("feather-icon",{staticClass:"mr-50",attrs:{icon:"ArrowLeftIcon",size:"18"}}),t._v(" Back ")],1),n("div",{staticClass:"summary-customer"},[n("div",{staticClass:"customer-info-display"},[t.selectedCustomer?n("strong",[t._v(t._s(t.selectedCustomer.name))]):t.passengerCustomer?n("strong",[t._v(t._s(t.passengerCustomer.name))]):t._e(),!t.passengerCustomer||t.selectedCustomer&&"PASSENGER"!==t.selectedCustomer.customerCode?t._e():n("b-badge",{staticClass:"ml-2",attrs:{variant:"info"}},[t._v("Default")]),t.selectedCustomer?n("small",{staticClass:"text-muted d-block"},[t._v(t._s(t.selectedCustomer.customerCode))]):t.passengerCustomer?n("small",{staticClass:"text-muted d-block"},[t._v(t._s(t.passengerCustomer.customerCode))]):t._e()],1)])],1),n("div",{staticClass:"summary-totals"},[n("div",{staticClass:"summary-item"},[n("span",{staticClass:"summary-label"},[t._v("Ticket Total:")]),n("span",{staticClass:"summary-value"},[t._v(t._s(t.formatTunCurrency(t.orderSummary.totalAmount)))])]),t.headerDiscountAmount>0?n("div",{staticClass:"summary-item"},[n("span",{staticClass:"summary-label"},[t._v("Discount:")]),n("span",{staticClass:"summary-value text-danger"},[t.orderSummary&&(t.orderSummary.discountPercent>0||t.orderSummary.discountAmount>0)?[t.orderSummary.discountPercent>0?n("span",[t._v(" "+t._s(t.orderSummary.discountPercent.toFixed(3))+"% ")]):t._e(),t.orderSummary.discountPercent>0&&t.orderSummary.discountAmount>0?n("span",[t._v(" / ")]):t._e(),t.orderSummary.discountAmount>0?n("span",[t._v(" "+t._s(t.formatTunCurrency(t.orderSummary.discountAmount))+" ")]):t._e()]:t._e()],2)]):t._e(),n("div",{staticClass:"summary-item"},[n("span",{staticClass:"summary-label"},[t._v("Total After Discount:")]),n("span",{staticClass:"summary-value"},[t._v(t._s(t.formatTunCurrency(t.totalAfterDiscount)))])]),n("div",{staticClass:"summary-item"},[n("span",{staticClass:"summary-label"},[t._v("Total Paid:")]),n("span",{staticClass:"summary-value text-success"},[t._v(t._s(t.formatTunCurrency(t.totalPaid)))])]),n("div",{staticClass:"summary-item"},[n("span",{staticClass:"summary-label"},[t._v("Remaining:")]),n("span",{staticClass:"summary-value",class:t.remainingBalance>0?"text-danger":"text-success"},[t._v(" "+t._s(t.formatTunCurrency(Math.abs(t.remainingBalance)))+" ")])])])]),n("div",{staticClass:"payment-main-content"},[n("div",{staticClass:"panel-payment-classes"},[t._m(0),n("div",{staticClass:"payment-classes-list"},t._l(t.paymentMethods,(function(e){return n("div",{key:e.id,staticClass:"payment-class-item",class:{active:t.selectedPaymentMethodId===e.id},on:{click:function(n){return t.selectPaymentMethod(e.id)}}},[n("span",{staticClass:"payment-class-name"},[t._v(t._s(e.name))]),n("span",{staticClass:"payment-class-total"},[t._v(t._s(t.formatTunCurrency(t.getTotalPaidByMethod(e.id))))])])})),0)]),n("div",{staticClass:"payment-right-content"},[n("div",{staticClass:"panel-payment-cards"},[t._m(1),n("div",{staticClass:"payment-cards-container"},[0===t.paymentCards.length?n("div",{staticClass:"empty-cards"},[n("feather-icon",{staticClass:"mb-2 text-muted",attrs:{icon:"CreditCardIcon",size:"48"}}),n("p",{staticClass:"mb-0 text-muted"},[t._v("Select a payment method to add payment")])],1):n("div",{staticClass:"payment-cards-list"},t._l(t.paymentCards,(function(e,a){return n("div",{key:e.id||a,staticClass:"payment-card",class:{selected:t.selectedCardIndex===a},on:{click:function(e){return t.selectCard(a)}}},[n("div",{staticClass:"payment-card-header"},[n("div",{staticClass:"payment-card-title"},[n("strong",[t._v(t._s(t.getPaymentMethodName(e.paymentMethodId)||"Unknown Method"))])]),n("b-button",{staticClass:"card-delete-btn",attrs:{variant:"link",size:"sm",disabled:t.loading},on:{click:function(e){return e.stopPropagation(),t.removeCard(a)}}},[n("feather-icon",{attrs:{icon:"XIcon",size:"16"}})],1)],1),n("div",{staticClass:"payment-card-body"},[t.isReturnVoucherPayment(e)?n("b-form-group",{staticClass:"mb-2",attrs:{label:"Voucher Number *"}},[n("b-input-group",[n("b-form-input",{attrs:{placeholder:"Enter voucher number...",disabled:t.loading,size:"sm"},on:{keyup:function(n){return!n.type.indexOf("key")&&t._k(n.keyCode,"enter",13,n.key,"Enter")?null:t.validateVoucher(e)},click:function(t){t.stopPropagation()}},model:{value:e.voucherNumber,callback:function(n){t.$set(e,"voucherNumber",n)},expression:"card.voucherNumber"}}),n("b-input-group-append",[n("b-button",{attrs:{variant:"outline-primary",disabled:t.loading||!e.voucherNumber,size:"sm"},on:{click:function(n){return t.validateVoucher(e)}}},[n("feather-icon",{attrs:{icon:"SearchIcon",size:"12"}})],1)],1)],1),void 0!==e.voucherRemainingAmount?n("small",{staticClass:"text-muted"},[t._v(" Remaining: "+t._s(t.formatTunCurrency(e.voucherRemainingAmount))+" ")]):t._e()],1):t._e(),n("b-form-group",{staticClass:"mb-2",attrs:{label:"Amount *"}},[n("b-input-group",[n("b-form-input",{ref:"amount-input-"+a,refInFor:!0,attrs:{type:"number",step:"0.01",min:"0.01",placeholder:"0.00",disabled:t.isReturnVoucherPayment(e)||t.loading,readonly:t.isReturnVoucherPayment(e),size:""},on:{input:t.updatePaymentTotal,click:function(t){t.stopPropagation()}},model:{value:e.amount,callback:function(n){t.$set(e,"amount",t._n(n))},expression:"card.amount"}}),n("b-input-group-append",[n("span",{staticClass:"input-group-text"},[t._v("TND")])])],1),t.isReturnVoucherPayment(e)?n("small",{staticClass:"text-muted"},[t._v(" Amount is automatically set from voucher ")]):t._e()],1),t.requiresTitleNumber(e)?n("b-form-group",{staticClass:"mb-2",attrs:{label:"N° Titre *"}},[n("b-form-input",{attrs:{placeholder:"N° du titre",size:"sm"},on:{click:function(t){t.stopPropagation()}},model:{value:e.titleNumber,callback:function(n){t.$set(e,"titleNumber",n)},expression:"card.titleNumber"}})],1):t._e(),t.requiresDueDate(e)?n("b-form-group",{staticClass:"mb-2",attrs:{label:"Date Échéance *"}},[n("b-form-input",{attrs:{type:"date",size:"sm"},on:{click:function(t){t.stopPropagation()}},model:{value:e.dueDate,callback:function(n){t.$set(e,"dueDate",n)},expression:"card.dueDate"}})],1):t._e(),t.requiresDrawerName(e)?n("b-form-group",{staticClass:"mb-2",attrs:{label:"Nom du tireur *"}},[n("b-form-input",{attrs:{placeholder:"Nom du tireur",size:"sm"},on:{click:function(t){t.stopPropagation()}},model:{value:e.drawerName,callback:function(n){t.$set(e,"drawerName",n)},expression:"card.drawerName"}})],1):t._e(),t.requiresIssuingBank(e)?n("b-form-group",{staticClass:"mb-2",attrs:{label:"Banque émettrice *"}},[n("b-form-input",{attrs:{placeholder:"Banque émettrice",size:"sm"},on:{click:function(t){t.stopPropagation()}},model:{value:e.issuingBank,callback:function(n){t.$set(e,"issuingBank",n)},expression:"card.issuingBank"}})],1):t._e()],1)])})),0)])]),n("div",{staticClass:"panel-keyboard"},[n("div",{staticClass:"keyboard-grid"},t._l([1,2,3,4,5,6,7,8,9,".",0,"⌫"],(function(e){return n("button",{key:e,staticClass:"keyboard-key",class:{"key-decimal":"."===e,"key-backspace":"⌫"===e},attrs:{disabled:t.loading},on:{click:function(n){return t.handleKeyboardKey(e)}}},[t._v(" "+t._s(e)+" ")])})),0)])])]),n("div",{staticClass:"panel-actions"},[n("b-button",{staticClass:"action-btn",attrs:{variant:"warning",size:"lg",disabled:0===t.cart.length||t.loading},on:{click:t.saveAsPending}},[n("feather-icon",{staticClass:"mr-50",attrs:{icon:"SaveIcon",size:"18"}}),t.loading?n("span",[t._v("Saving...")]):n("span",[t._v("Save as Pending")])],1),n("b-button",{staticClass:"action-btn",attrs:{variant:"info",size:"lg",disabled:t.loading},on:{click:t.openDiscountDialog}},[n("feather-icon",{staticClass:"mr-50",attrs:{icon:"PercentIcon",size:"18"}}),t._v(" Discount ")],1),n("b-button",{staticClass:"action-btn",attrs:{variant:"info",size:"lg",disabled:t.loading},on:{click:t.openCustomerDialog}},[n("feather-icon",{staticClass:"mr-50",attrs:{icon:"UsersIcon",size:"18"}}),t._v(" Customer ")],1),n("b-button",{staticClass:"action-btn",attrs:{variant:"success",size:"lg",disabled:!t.canCompletePayment||t.loading},on:{click:t.completePayment}},[n("feather-icon",{staticClass:"mr-50",attrs:{icon:"CheckCircleIcon",size:"18"}}),t.loading?n("span",[t._v("Processing...")]):n("span",[t._v("Complete Payment")])],1)],1),n("b-modal",{attrs:{title:"Apply Header Discount","hide-footer":"",centered:"",size:"md","no-close-on-backdrop":""},on:{hide:function(e){t.showDiscountDialog=!1}},model:{value:t.showDiscountDialog,callback:function(e){t.showDiscountDialog=e},expression:"showDiscountDialog"}},[n("div",{staticClass:"discount-dialog"},[n("b-form-group",{staticClass:"mb-3",attrs:{label:"Discount Type"}},[n("b-form-radio-group",{staticClass:"discount-type-radio",attrs:{options:[{text:"Percentage (%)",value:"percentage"},{text:"Amount (TND)",value:"amount"}]},model:{value:t.discountType,callback:function(e){t.discountType=e},expression:"discountType"}})],1),n("b-form-group",{staticClass:"mb-3",attrs:{label:"percentage"===t.discountType?"Discount Percentage":"Discount Amount"}},[n("b-input-group",[n("b-form-input",{attrs:{type:"number",step:(t.discountType,.01),min:0,max:"percentage"===t.discountType?100:t.orderSummary.totalAmount,placeholder:"percentage"===t.discountType?"Enter percentage...":"Enter amount..."},on:{input:t.updateDiscountPreview},model:{value:t.discountValue,callback:function(e){t.discountValue=t._n(e)},expression:"discountValue"}}),"percentage"===t.discountType?n("b-input-group-append",[n("span",{staticClass:"input-group-text"},[t._v("%")])]):n("b-input-group-append",[n("span",{staticClass:"input-group-text"},[t._v("TND")])])],1)],1),t.discountValue?n("div",{staticClass:"discount-preview mb-3 p-3",staticStyle:{background:"#f8f9fa","border-radius":"8px"}},[n("div",{staticClass:"d-flex justify-content-between mb-2"},[n("span",[t._v("Ticket Total:")]),n("strong",[t._v(t._s(t.formatTunCurrency(t.orderSummary.totalAmount)))])]),n("div",{staticClass:"d-flex justify-content-between mb-2"},[n("span",[t._v("Discount:")]),n("strong",{staticClass:"text-danger"},[t._v(" "+t._s(t.formatTunCurrency(t.calculatePreviewDiscount()))+" "),"percentage"===t.discountType?n("span",[t._v("("+t._s(t.discountValue)+"%)")]):t._e()])]),n("hr"),n("div",{staticClass:"d-flex justify-content-between"},[n("span",[n("strong",[t._v("Total After Discount:")])]),n("strong",{staticClass:"text-success"},[t._v(t._s(t.formatTunCurrency(t.calculatePreviewTotal())))])])]):t._e(),n("div",{staticClass:"d-flex justify-content-end"},[n("b-button",{staticClass:"mr-2",attrs:{variant:"secondary"},on:{click:function(e){t.showDiscountDialog=!1}}},[t._v(" Cancel ")]),t.orderSummary.discountAmount>0||t.orderSummary.discountPercent>0?n("b-button",{staticClass:"mr-2",attrs:{variant:"danger"},on:{click:t.clearHeaderDiscount}},[t._v(" Clear Discount ")]):t._e(),n("b-button",{attrs:{variant:"primary",disabled:!t.discountValue||t.discountValue<=0},on:{click:t.applyHeaderDiscount}},[t._v(" Apply Discount ")])],1)],1)])],1)},r=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"payment-classes-header"},[n("h5",[t._v("Payment Methods")])])},function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"payment-cards-header"},[n("h5",[t._v("Payment Details")])])}],s=n("c7eb"),i=n("1da1"),o=n("5530"),u=(n("99af"),n("4de4"),n("7db0"),n("caad"),n("d81d"),n("13d5"),n("fb6a"),n("4e82"),n("a434"),n("b0c0"),n("d3b7"),n("2532"),n("498a"),n("475a")),c=n("223c"),l=n("62c5"),d=n.n(l),m={name:"Payment",data:function(){return{cart:[],orderSummary:{},paymentMethods:[],paymentCards:[],loading:!1,customers:[],selectedCustomerId:null,customerSearchTerm:"",customerSearchResults:[],showCustomerDropdown:!1,searchingCustomers:!1,passengerCustomer:null,selectedCustomerObj:null,searchTimeout:null,pendingTicketsCount:0,selectedPaymentMethodId:null,selectedCardIndex:null,cardIdCounter:0,showDiscountDialog:!1,discountType:"percentage",discountValue:null}},computed:{pendingTicketId:function(){return this.$store.state.pos.pendingTicketId},selectedCustomer:function(){var t=this;return this.selectedCustomerId?this.passengerCustomer&&this.selectedCustomerId===this.passengerCustomer.id?this.passengerCustomer:this.customerSearchResults.find((function(e){return e.id===t.selectedCustomerId}))||this.selectedCustomerObj||null:this.passengerCustomer},totalPaid:function(){return this.paymentCards.reduce((function(t,e){var n=parseFloat(e.amount)||0;return t+n}),0)},headerDiscountAmount:function(){var t,e=(null===(t=this.$store.state.pos)||void 0===t?void 0:t.orderSummary)||this.orderSummary;if(!e||!e.totalAmount)return 0;var n=e.totalAmount;return e.discountAmount&&e.discountAmount>0?e.discountAmount:e.discountPercent&&e.discountPercent>0?n*(e.discountPercent/100):0},totalAfterDiscount:function(){var t,e=(null===(t=this.$store.state.pos)||void 0===t?void 0:t.orderSummary)||this.orderSummary,n=(null===e||void 0===e?void 0:e.totalAmount)||0,a=this.headerDiscountAmount;return Math.max(0,n-a)},remainingBalance:function(){return this.totalAfterDiscount-this.totalPaid},isFullyPaid:function(){return this.remainingBalance<=.01},canCompletePayment:function(){var t=this;if(0===this.paymentCards.length)return!1;var e=this.paymentCards.every((function(e){if(!e.paymentMethodId)return!1;var n=t.getPaymentMethodById(e.paymentMethodId);if(!n)return!1;var a=parseFloat(e.amount);if(!t.isReturnVoucherPayment(e)&&(!a||a<=0))return!1;if(t.isReturnVoucherPayment(e)){if(!e.voucherNumber||!e.voucherNumber.trim())return!1;if(!a||a<=0)return!1}return!!(!n.requireTitleNumber||e.titleNumber&&e.titleNumber.trim())&&(!(n.requireDueDate&&(!e.dueDate||""===e.dueDate))&&(!!(!n.requireDrawerName||e.drawerName&&e.drawerName.trim())&&!!(!n.requireIssuingBank||e.issuingBank&&e.issuingBank.trim())))}));return e&&this.remainingBalance<=.01}},watch:{"$store.state.pos.orderSummary":{handler:function(t){t&&(this.orderSummary=Object(o["a"])({},t))},deep:!0,immediate:!0}},mounted:function(){var t=this;return Object(i["a"])(Object(s["a"])().mark((function e(){return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.loadCartData(),e.next=3,t.loadPaymentMethods();case 3:return e.next=5,t.loadPassengerCustomer();case 5:t.loadPendingTicketsCount(),t.resetCustomerToPassenger(),t.initializeDefaultPayment(),document.addEventListener("keydown",t.handleKeyboardInput);case 9:case"end":return e.stop()}}),e)})))()},beforeDestroy:function(){document.removeEventListener("keydown",this.handleKeyboardInput),this.searchTimeout&&clearTimeout(this.searchTimeout)},methods:{loadCartData:function(){var t=this;if(!this.$store.state.pos)return console.error("POS store module not found"),void this.$router.push({name:"pos-item-selection"});this.cart=this.$store.state.pos.cart||[];var e=this.$store.state.pos.orderSummary;this.orderSummary=e||{subtotal:0,taxAmount:0,totalAmount:0,discountAmount:0,discountPercent:0},null!==this.orderSummary.subtotal&&void 0!==this.orderSummary.subtotal||(this.orderSummary.subtotal=0),null!==this.orderSummary.taxAmount&&void 0!==this.orderSummary.taxAmount||(this.orderSummary.taxAmount=0),null!==this.orderSummary.totalAmount&&void 0!==this.orderSummary.totalAmount||(this.orderSummary.totalAmount=0),null!==this.orderSummary.discountAmount&&void 0!==this.orderSummary.discountAmount||(this.orderSummary.discountAmount=0),null!==this.orderSummary.discountPercent&&void 0!==this.orderSummary.discountPercent||(this.orderSummary.discountPercent=0),console.log("Payment page - Cart:",this.cart),console.log("Payment page - Order Summary:",this.orderSummary),0===this.cart.length&&(this.$toast({component:c["default"],props:{title:"No Items",icon:"AlertCircleIcon",text:"Cart is empty. Redirecting to item selection...",variant:"warning"}}),setTimeout((function(){t.$router.push({name:"pos-item-selection"})}),1500))},loadPassengerCustomer:function(){var t=this;return Object(i["a"])(Object(s["a"])().mark((function e(){var n;return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.$http.get("/customer/passenger");case 3:n=e.sent,200===n.status&&n.data&&(t.passengerCustomer=n.data),e.next=10;break;case 7:e.prev=7,e.t0=e["catch"](0),console.error("Error loading passenger customer:",e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))()},resetCustomerToPassenger:function(){this.pendingTicketId||this.passengerCustomer&&(this.selectedCustomerId=this.passengerCustomer.id,this.selectedCustomerObj=null,this.customerSearchTerm="",this.customerSearchResults=[],this.showCustomerDropdown=!1,this.$store.dispatch("pos/setSelectedCustomerId",this.passengerCustomer.id))},loadSelectedCustomerDetails:function(){var t=this;return Object(i["a"])(Object(s["a"])().mark((function e(){var n;return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.selectedCustomerId){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,t.$http.get("/customer/".concat(t.selectedCustomerId));case 5:n=e.sent,200===n.status&&n.data&&(t.selectedCustomerObj=n.data,t.customerSearchTerm="".concat(n.data.customerCode," - ").concat(n.data.name)),e.next=12;break;case 9:e.prev=9,e.t0=e["catch"](2),console.error("Error loading selected customer:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[2,9]])})))()},searchCustomers:function(){var t=this;this.searchTimeout&&clearTimeout(this.searchTimeout);var e=this.customerSearchTerm.trim();if(!e)return this.customerSearchResults=[],void(this.showCustomerDropdown=!1);this.showCustomerDropdown=!0,this.searchTimeout=setTimeout(Object(i["a"])(Object(s["a"])().mark((function n(){var a;return Object(s["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:return t.searchingCustomers=!0,n.prev=1,n.next=4,t.$http.get("/customer/search",{params:{q:e}});case 4:a=n.sent,200===a.status&&(t.customerSearchResults=a.data||[]),n.next=12;break;case 8:n.prev=8,n.t0=n["catch"](1),console.error("Error searching customers:",n.t0),t.customerSearchResults=[];case 12:return n.prev=12,t.searchingCustomers=!1,n.finish(12);case 15:case"end":return n.stop()}}),n,null,[[1,8,12,15]])}))),300)},selectCustomer:function(t){this.selectedCustomerId=t.id,this.selectedCustomerObj=t,this.customerSearchTerm="".concat(t.customerCode," - ").concat(t.name),this.showCustomerDropdown=!1,this.onCustomerChange()},clearCustomerSelection:function(){this.selectedCustomerId=this.passengerCustomer?this.passengerCustomer.id:null,this.selectedCustomerObj=null,this.customerSearchTerm="",this.showCustomerDropdown=!1,this.customerSearchResults=[],this.onCustomerChange()},onCustomerChange:function(){this.$store.state.pos&&this.$store.dispatch("pos/setSelectedCustomerId",this.selectedCustomerId)},openCustomerDialog:function(){this.$toast({component:c["default"],props:{title:"Coming Soon",icon:"InfoIcon",text:"Customer selection dialog will be implemented soon",variant:"info"}})},openDiscountDialog:function(){this.orderSummary&&this.orderSummary.discountPercent&&this.orderSummary.discountPercent>0?(this.discountType="percentage",this.discountValue=this.orderSummary.discountPercent):this.orderSummary&&this.orderSummary.discountAmount&&this.orderSummary.discountAmount>0?(this.discountType="amount",this.discountValue=this.orderSummary.discountAmount):(this.discountType="percentage",this.discountValue=null),this.showDiscountDialog=!0},applyHeaderDiscount:function(){var t,e=(null===(t=this.$store.state.pos)||void 0===t?void 0:t.orderSummary)||this.orderSummary,n=(null===e||void 0===e?void 0:e.totalAmount)||0;if(!n||!this.discountValue||this.discountValue<=0)this.clearHeaderDiscount();else{var a=null,r=null;if("percentage"===this.discountType){var s=Math.min(100,Math.max(0,parseFloat(this.discountValue)||0));a=s,r=n*(s/100)}else{var i=Math.min(parseFloat(this.discountValue)||0,n);r=i,a=n>0?r/n*100:0}this.$store.state.pos?this.$store.dispatch("pos/updateOrderSummary",{discountAmount:r,discountPercent:a}):(this.$set(this.orderSummary,"discountAmount",r),this.$set(this.orderSummary,"discountPercent",a)),this.showDiscountDialog=!1,this.discountValue=null}},clearHeaderDiscount:function(){this.$store.state.pos?this.$store.dispatch("pos/updateOrderSummary",{discountAmount:0,discountPercent:0}):(this.$set(this.orderSummary,"discountAmount",0),this.$set(this.orderSummary,"discountPercent",0)),this.showDiscountDialog=!1,this.discountValue=null},calculatePreviewDiscount:function(){var t;if(!this.discountValue||null===(t=this.orderSummary)||void 0===t||!t.totalAmount)return 0;var e=this.orderSummary.totalAmount;if("percentage"===this.discountType){var n=Math.min(100,Math.max(0,parseFloat(this.discountValue)||0));return e*(n/100)}var a=Math.min(parseFloat(this.discountValue)||0,e);return a},calculatePreviewTotal:function(){var t,e=(null===(t=this.orderSummary)||void 0===t?void 0:t.totalAmount)||0,n=this.calculatePreviewDiscount();return Math.max(0,e-n)},updateDiscountPreview:function(){this.$forceUpdate()},loadPaymentMethods:function(){var t=this;return Object(i["a"])(Object(s["a"])().mark((function e(){var n;return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.$http.get("/payment-method");case 3:n=e.sent,t.paymentMethods=n.data.filter((function(t){return!1!==t.active})).sort((function(t,e){var n=null!=t.displayOrder?t.displayOrder:999,a=null!=e.displayOrder?e.displayOrder:999;return n-a})),e.next=11;break;case 7:e.prev=7,e.t0=e["catch"](0),console.error("Error loading payment methods:",e.t0),t.paymentMethods=[{id:1,name:"Client Espèce",type:"CLIENT_ESPECES",active:!0,displayOrder:1},{id:2,name:"Return Voucher",type:"RETURN_VOUCHER",active:!0,displayOrder:8}];case 11:case"end":return e.stop()}}),e,null,[[0,7]])})))()},getClientEspecesPaymentMethod:function(){return this.paymentMethods.find((function(t){return"CLIENT_ESPECES"===t.type}))||null},initializeDefaultPayment:function(){var t=this.getClientEspecesPaymentMethod();t&&(this.selectedPaymentMethodId=t.id,this.addOrUpdatePaymentCard(t.id))},selectPaymentMethod:function(t){this.selectedPaymentMethodId=t,this.addOrUpdatePaymentCard(t)},addOrUpdatePaymentCard:function(t){var e=this,n=this.getPaymentMethodById(t);if(n){if("CLIENT_ESPECES"===n.type){var a=this.paymentCards.find((function(t){var n=e.getPaymentMethodById(t.paymentMethodId);return n&&"CLIENT_ESPECES"===n.type}));if(a){var r=this.paymentCards.indexOf(a);return void this.selectCard(r)}}var s={id:"card-".concat(++this.cardIdCounter),paymentMethodId:t,amount:null,voucherNumber:"",voucherRemainingAmount:void 0,titleNumber:"",dueDate:"",drawerName:"",issuingBank:""};this.paymentCards.unshift(s),this.selectedCardIndex=0,this.updatePaymentTotal(),this.$nextTick((function(){e.focusAmountInput(0)}))}},selectCard:function(t){if(!(t<0||t>=this.paymentCards.length)){var e=this.paymentCards[t];this.paymentCards.splice(t,1),this.paymentCards.unshift(e),this.selectedCardIndex=0,this.updatePaymentTotal()}},removeCard:function(t){if(!(t<0||t>=this.paymentCards.length)){if(this.paymentCards.splice(t,1),this.selectedCardIndex===t?this.paymentCards.length>0?this.selectedCardIndex=0:this.selectedCardIndex=null:this.selectedCardIndex>t&&this.selectedCardIndex--,0===this.paymentCards.length&&this.selectedPaymentMethodId){var e=this.getPaymentMethodById(this.selectedPaymentMethodId);e&&"CLIENT_ESPECES"===e.type&&this.addOrUpdatePaymentCard(this.selectedPaymentMethodId)}this.updatePaymentTotal()}},getTotalPaidByMethod:function(t){return this.paymentCards.filter((function(e){return e.paymentMethodId===t})).reduce((function(t,e){var n=parseFloat(e.amount)||0;return t+n}),0)},getPaymentMethodName:function(t){if(!t)return null;var e=this.paymentMethods.find((function(e){return e.id===t}));return e?e.name:null},getPaymentMethodById:function(t){return t&&this.paymentMethods.find((function(e){return e.id===t}))||null},isReturnVoucherPayment:function(t){var e=this.getPaymentMethodById(t?t.paymentMethodId:null);return e&&"RETURN_VOUCHER"===e.type},requiresTitleNumber:function(t){var e=this.getPaymentMethodById(t?t.paymentMethodId:null);return e&&e.requireTitleNumber},requiresDueDate:function(t){var e=this.getPaymentMethodById(t?t.paymentMethodId:null);return e&&e.requireDueDate},requiresDrawerName:function(t){var e=this.getPaymentMethodById(t?t.paymentMethodId:null);return e&&e.requireDrawerName},requiresIssuingBank:function(t){var e=this.getPaymentMethodById(t?t.paymentMethodId:null);return e&&e.requireIssuingBank},onPaymentMethodChange:function(t){this.isReturnVoucherPayment(t)||(t.voucherNumber="",t.voucherRemainingAmount=void 0,t.amount&&t.amount>0&&(t.amount=0)),t.titleNumber="",t.dueDate="",t.drawerName="",t.issuingBank="",this.updatePaymentTotal()},validateVoucher:function(t){var e=this;return Object(i["a"])(Object(s["a"])().mark((function n(){var a,r,i,o;return Object(s["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t.voucherNumber&&t.voucherNumber.trim()){n.next=2;break}return n.abrupt("return");case 2:return e.loading=!0,n.prev=3,n.next=6,e.$http.get("/return-voucher/validate",{params:{voucherNumber:t.voucherNumber.trim()}});case 6:if(a=n.sent,200!==a.status){n.next=19;break}if(r=a.data,r.isValid){n.next=14;break}return e.$toast({component:c["default"],props:{title:"Invalid Voucher",icon:"XIcon",text:"This voucher is expired or fully used",variant:"danger"}}),t.voucherRemainingAmount=0,t.amount=0,n.abrupt("return");case 14:t.voucherRemainingAmount=r.remainingAmount,i=e.remainingBalance,t.amount=Math.min(r.remainingAmount,i),e.updatePaymentTotal(),e.$toast({component:c["default"],props:{title:"Voucher Validated",icon:"CheckCircleIcon",text:"Voucher validated. Remaining amount: ".concat(e.formatTunCurrency(r.remainingAmount)),variant:"success"}});case 19:n.next=30;break;case 21:n.prev=21,n.t0=n["catch"](3),console.error("Error validating voucher:",n.t0),o="Failed to validate voucher. Please check the voucher number.",n.t0.response&&n.t0.response.data&&(o=n.t0.response.data.message||n.t0.response.data||o),e.$toast({component:c["default"],props:{title:"Error",icon:"XIcon",text:o,variant:"danger"}}),t.voucherRemainingAmount=void 0,t.amount=0,e.updatePaymentTotal();case 30:return n.prev=30,e.loading=!1,n.finish(30);case 33:case"end":return n.stop()}}),n,null,[[3,21,30,33]])})))()},focusAmountInput:function(t){var e=this.$refs["amount-input-".concat(t)];e&&e.length>0?e[0].focus():e&&e.focus()},handleKeyboardInput:function(t){"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&"SELECT"!==t.target.tagName&&((t.key>="0"&&t.key<="9"||"."===t.key)&&(t.preventDefault(),this.handleKeyboardKey(t.key)),"Backspace"===t.key&&(t.preventDefault(),this.handleKeyboardKey("⌫")),"Enter"===t.key&&this.canCompletePayment&&this.completePayment())},handleKeyboardKey:function(t){if(null===this.selectedCardIndex||this.selectedCardIndex>=this.paymentCards.length){var e=this.getClientEspecesPaymentMethod();if(!e)return;this.selectedPaymentMethodId=e.id,this.addOrUpdatePaymentCard(e.id)}var n=this.paymentCards[this.selectedCardIndex];if(n&&!this.isReturnVoucherPayment(n))if("⌫"===t){var a=n.amount?String(n.amount):"";if(a.length>0){var r=a.slice(0,-1);n.amount=r?parseFloat(r):null,this.updatePaymentTotal()}}else if("."===t){var s=n.amount?String(n.amount):"0";s.includes(".")||(n.amount=parseFloat(s+".")||0,this.updatePaymentTotal())}else if(t>="0"&&t<="9"){var i=n.amount?String(n.amount):"0",o="0"===i?t:i+t;n.amount=parseFloat(o)||0,this.updatePaymentTotal()}},updatePaymentTotal:function(){this.$forceUpdate()},formatTunCurrency:function(t){var e=parseFloat(t)||0,n=e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return"".concat(n," TND")},goBack:function(){this.$router.push({name:"pos-item-selection"})},printReceipt:function(t){var e=this;return Object(i["a"])(Object(s["a"])().mark((function n(){var a,r,i,o,l,m;return Object(s["a"])().wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(console.log("Printing receipt with data:",t),a=e.$root.constructor||e.$options._base,r=a.extend(u["a"]),i=new r({parent:e,propsData:{saleData:t}}),i.$mount(),o=window.open("","_blank"),o){n.next=9;break}return e.$toast({component:c["default"],props:{title:"Print Error",icon:"XIcon",text:"Please allow popups to print receipts",variant:"warning"}}),n.abrupt("return");case 9:return n.next=11,e.$nextTick();case 11:return n.next=13,new Promise((function(t){return setTimeout(t,200)}));case 13:if(l=t.salesNumber||null,l&&i.$el)try{m=i.$el.querySelector(".barcode-svg"),m&&d()(m,l,{format:"CODE128",width:1.5,height:40,displayValue:!1,margin:5,background:"#ffffff",lineColor:"#000000"})}catch(s){console.error("Error generating barcode:",s)}o.document.write("\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <title>Receipt - ".concat(t.salesNumber,"</title>\n          <style>\n            @page {\n              size: 80mm auto;\n              margin: 0;\n            }\n            body {\n              margin: 0;\n              padding: 10mm;\n              font-family: 'Courier New', monospace;\n              font-size: 12px;\n              line-height: 1.4;\n              background: white;\n              color: black;\n            }\n            .receipt-template {\n              width: 100%;\n              max-width: 80mm;\n            }\n            .receipt-header { margin-bottom: 15px; }\n            .receipt-header h2 { font-size: 16px; margin: 5px 0; font-weight: bold; text-align: center; }\n            .receipt-header h3 { font-size: 14px; margin: 5px 0; font-weight: bold; text-align: center; }\n            .receipt-divider { margin: 8px 0; text-align: center; }\n            .receipt-info, .receipt-items, .receipt-totals, .receipt-payments { margin-bottom: 10px; }\n            .receipt-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; }\n            .receipt-row.total { font-weight: bold; font-size: 14px; margin-top: 8px; }\n            .receipt-row .label { text-align: left; }\n            .receipt-row .value { text-align: right; font-weight: bold; }\n            .item-name { flex: 2; text-align: left; }\n            .item-qty { flex: 0.5; text-align: center; }\n            .item-total { flex: 1; text-align: right; }\n            .item-code { font-size: 10px; color: #666; margin-left: 10px; margin-bottom: 6px; }\n            .receipt-section-header { font-weight: bold; text-align: center; margin: 8px 0; }\n            .receipt-footer { margin-top: 20px; text-align: center; font-size: 11px; }\n            .receipt-item { margin-bottom: 8px; }\n            .payment-entry { margin-bottom: 8px; }\n            .receipt-barcode { margin: 15px 0; text-align: center; }\n            .barcode-container { display: flex; justify-content: center; align-items: center; margin: 10px 0; }\n            .barcode-svg { max-width: 100%; height: auto; }\n            .barcode-text { font-size: 11px; font-weight: bold; margin-top: 5px; letter-spacing: 1px; text-align: center; }\n          </style>\n        </head>\n        <body>\n          ").concat(i.$el.outerHTML,"\n        </body>\n        </html>\n      ")),o.document.close(),setTimeout((function(){o.focus(),o.print(),setTimeout((function(){o.close(),i&&i.$el&&i.$destroy()}),500)}),500);case 18:case"end":return n.stop()}}),n)})))()},completePayment:function(){var t=this;return Object(i["a"])(Object(s["a"])().mark((function e(){var n,a,r,i,o,u;return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.canCompletePayment){e.next=2;break}return e.abrupt("return");case 2:if(t.loading=!0,e.prev=3,a=t.paymentCards.filter((function(t){return t.paymentMethodId})).map((function(e){var n=t.isReturnVoucherPayment(e)&&e.voucherNumber||null;return{paymentMethodId:e.paymentMethodId,amount:parseFloat(e.amount),reference:n,notes:null,titleNumber:e.titleNumber?e.titleNumber.trim():null,dueDate:e.dueDate||null,drawerName:e.drawerName?e.drawerName.trim():null,issuingBank:e.issuingBank?e.issuingBank.trim():null}})),r={subtotal:t.orderSummary.subtotal,taxAmount:t.orderSummary.taxAmount,discountAmount:t.orderSummary.discountAmount||0,discountPercentage:t.orderSummary.discountPercent||null,totalAmount:t.totalAfterDiscount,paidAmount:t.totalPaid,changeAmount:t.remainingBalance<0?Math.abs(t.remainingBalance):0,customerId:t.selectedCustomerId||null,notes:"Payment via ".concat(a.length," method(s)"),lines:t.cart.map((function(t){var e=t.unitPrice*t.quantity,n=t.defaultVAT||0,a=e*(1+n/100),r=0;t.discountPercentage?r=a*(t.discountPercentage/100):t.discountAmount&&(r=t.discountAmount);var s=Math.max(0,a-r),i=s/(1+n/100),o=s-i,u=t.unitPrice*(1+n/100);return{itemId:t.id,quantity:t.quantity,unitPrice:t.unitPrice,lineTotal:i,discountPercentage:t.discountPercentage||null,discountAmount:r||null,vatAmount:o,vatPercent:n,unitPriceIncludingVat:u,lineTotalIncludingVat:s}})),payments:a},i=!!t.pendingTicketId,console.log("=== Payment Processing ==="),console.log("Pending Ticket ID:",t.pendingTicketId),console.log("Is Pending Ticket:",i),!i){e.next=17;break}return console.log("✓ Completing pending ticket ".concat(t.pendingTicketId)),e.next=14,t.$http.post("/sales-header/complete-pending/".concat(t.pendingTicketId),r);case 14:o=e.sent,e.next=21;break;case 17:return console.log("✗ Creating NEW sale"),e.next=20,t.$http.post("/sales-header/process-sale",r);case 20:o=e.sent;case 21:console.log("✓ Payment Response - Sales Number:",null===(n=o.data)||void 0===n?void 0:n.salesNumber),200===o.status&&(t.$store.dispatch("pos/clearCart"),t.$store.dispatch("pos/clearOrderSummary"),t.$store.dispatch("pos/clearPendingTicketId"),t.resetCustomerToPassenger(),t.$toast({component:c["default"],props:{title:"Success",icon:"CheckCircleIcon",text:"Sale ".concat(o.data.salesNumber," completed!"),variant:"success"}}),t.printReceipt(o.data),setTimeout((function(){t.$router.push({name:"pos-item-selection"})}),2e3)),e.next=31;break;case 25:e.prev=25,e.t0=e["catch"](3),console.error("Error completing payment:",e.t0),u="Failed to complete payment. Please try again.",e.t0.response&&e.t0.response.data&&(u=e.t0.response.data||u),t.$toast({component:c["default"],props:{title:"Error",icon:"XIcon",text:u,variant:"danger"}});case 31:return e.prev=31,t.loading=!1,e.finish(31);case 34:case"end":return e.stop()}}),e,null,[[3,25,31,34]])})))()},saveAsPending:function(){var t=this;return Object(i["a"])(Object(s["a"])().mark((function e(){var n,a,r;return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(0!==t.cart.length){e.next=2;break}return e.abrupt("return");case 2:return t.loading=!0,e.prev=3,n={subtotal:t.orderSummary.subtotal,taxAmount:t.orderSummary.taxAmount,discountAmount:t.orderSummary.discountAmount||0,discountPercentage:t.orderSummary.discountPercent||null,totalAmount:t.totalAfterDiscount,paidAmount:0,changeAmount:0,customerId:t.selectedCustomerId||null,notes:"Pending sale - customer will return",lines:t.cart.map((function(t){var e=t.unitPrice*t.quantity,n=t.defaultVAT||0,a=e*(1+n/100),r=0;t.discountPercentage?r=a*(t.discountPercentage/100):t.discountAmount&&(r=t.discountAmount);var s=Math.max(0,a-r),i=s/(1+n/100),o=s-i,u=t.unitPrice*(1+n/100);return{itemId:t.id,quantity:t.quantity,unitPrice:t.unitPrice,lineTotal:i,discountPercentage:t.discountPercentage||null,discountAmount:r||null,vatAmount:o,vatPercent:n,unitPriceIncludingVat:u,lineTotalIncludingVat:s}})),payments:[]},e.next=7,t.$http.post("/sales-header/save-pending",n);case 7:a=e.sent,200===a.status&&(t.$store.dispatch("pos/clearCart"),t.$store.dispatch("pos/clearOrderSummary"),t.resetCustomerToPassenger(),t.$toast({component:c["default"],props:{title:"Success",icon:"CheckCircleIcon",text:"Pending ticket ".concat(a.data.salesNumber," saved!"),variant:"success"}}),setTimeout((function(){t.$router.push({name:"pos-item-selection"})}),1500)),e.next=17;break;case 11:e.prev=11,e.t0=e["catch"](3),console.error("Error saving pending sale:",e.t0),r="Failed to save pending sale. Please try again.",e.t0.response&&e.t0.response.data&&(r=e.t0.response.data||r),t.$toast({component:c["default"],props:{title:"Error",icon:"XIcon",text:r,variant:"danger"}});case 17:return e.prev=17,t.loading=!1,e.finish(17);case 20:case"end":return e.stop()}}),e,null,[[3,11,17,20]])})))()},loadPendingTicketsCount:function(){var t=this;return Object(i["a"])(Object(s["a"])().mark((function e(){var n;return Object(s["a"])().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.$http.get("/sales-header/pending-sales");case 3:n=e.sent,n.data&&(t.pendingTicketsCount=n.data.length||0),e.next=11;break;case 7:e.prev=7,e.t0=e["catch"](0),console.error("Error loading pending tickets count:",e.t0),t.pendingTicketsCount=0;case 11:case"end":return e.stop()}}),e,null,[[0,7]])})))()}}},p=m,h=(n("7793"),n("2877")),y=Object(h["a"])(p,a,r,!1,null,"76d49d1c",null);e["default"]=y.exports}}]);
//# sourceMappingURL=chunk-9fec372c.558f1865.js.map